#!/bin/sh
exec >> /proc/1/fd/1 2>&1
# ===============================================================================
#   K3D Cluster Creation
#   this script access the parametter i.e num of nodes i.e NUM_WORKERS
#   example command to run this script  ./setup.sh 3 cluster1
# ===============================================================================

NUM_WORKERS=${1:-0}  # Default to 1 worker if not provided
CLUSTER_NAME=${2:-cluster}

# Check if k3d is installed, if not install it
if ! command -v k3d &> /dev/null; then
    echo "$(date '+%Y-%m-%d %H:%M:%S') | k3d not found. Attempting installation..."
    
    # Retry k3d installation up to 5 times
    INSTALL_ATTEMPTS=0
    MAX_INSTALL_ATTEMPTS=5
    while [ $INSTALL_ATTEMPTS -lt $MAX_INSTALL_ATTEMPTS ]; do
        INSTALL_ATTEMPTS=$((INSTALL_ATTEMPTS+1))
        echo "$(date '+%Y-%m-%d %H:%M:%S') | Installation attempt $INSTALL_ATTEMPTS/$MAX_INSTALL_ATTEMPTS"
        
        # Use the same installation method as in entrypoint.sh
        TAG=v5.8.3 bash /usr/local/bin/k3d-install.sh
        
        # Check if installation was successful
        if command -v k3d &> /dev/null; then
            echo "$(date '+%Y-%m-%d %H:%M:%S') | k3d successfully installed"
            break
        else
            if [ $INSTALL_ATTEMPTS -lt $MAX_INSTALL_ATTEMPTS ]; then
                echo "$(date '+%Y-%m-%d %H:%M:%S') | k3d installation failed. Retrying in 10 seconds..."
                sleep 10
            fi
        fi
    done
    
    # If k3d still not installed after max attempts, exit with error
    if ! command -v k3d &> /dev/null; then
        echo "$(date '+%Y-%m-%d %H:%M:%S') | ERROR: Failed to install k3d after $MAX_INSTALL_ATTEMPTS attempts"
        exit 1
    fi
fi

# Check if cluster already exists and reuse it for faster startup
if k3d cluster list | grep -q "$CLUSTER_NAME"; then
    echo "$(date '+%Y-%m-%d %H:%M:%S') | ✅ Cluster '$CLUSTER_NAME' already exists, reusing it for faster startup"
    echo "$(date '+%Y-%m-%d %H:%M:%S') | Skipping cluster creation to save time"
    # Still need to ensure kubeconfig is correct even when reusing cluster
    k3d kubeconfig write $CLUSTER_NAME --kubeconfig-switch-context=false
    # Update kubeconfig to use loadbalancer container name
    if [ -f /home/candidate/.kube/config ]; then
        sed -i 's|server: https://[^[:space:]]*|server: https://k3d-cluster-serverlb:6443|g' /home/candidate/.kube/config
        sed -i '/certificate-authority-data:/d' /home/candidate/.kube/config
        if ! grep -q "insecure-skip-tls-verify" /home/candidate/.kube/config; then
            sed -i '/server: https:\/\/k3d-cluster-serverlb:6443/a\    insecure-skip-tls-verify: true' /home/candidate/.kube/config
        fi
    fi
    cp /home/candidate/.kube/config /home/candidate/.kube/kubeconfig
    sed -i 's|server: https://[^[:space:]]*|server: https://k3d-cluster-serverlb:6443|g' /home/candidate/.kube/kubeconfig
    sed -i '/certificate-authority-data:/d' /home/candidate/.kube/kubeconfig
    if ! grep -q "insecure-skip-tls-verify" /home/candidate/.kube/kubeconfig; then
        sed -i '/server: https:\/\/k3d-cluster-serverlb:6443/a\    insecure-skip-tls-verify: true' /home/candidate/.kube/kubeconfig
    fi
    echo "$(date '+%Y-%m-%d %H:%M:%S') | ✅ Kubeconfig updated for existing cluster"
    exit 0
fi

echo "$(date '+%Y-%m-%d %H:%M:%S') | Creating new cluster '$CLUSTER_NAME' with $NUM_WORKERS worker nodes"

# Delete cluster config if exists
if [ -f "k3d-config.yaml" ]; then  
    echo "k3d-config.yaml already exists, deleting it"
    rm -f k3d-config.yaml
fi

# Generate K3d config (must match entrypoint.sh configuration for network and port)
cat <<EOF > /tmp/k3d-config.yaml
apiVersion: k3d.io/v1alpha5
kind: Simple
metadata:
  name: $CLUSTER_NAME
network: ckx-network
servers: 1
agents: $NUM_WORKERS
ports:
  - port: "6445:6443"
    nodeFilters:
      - loadbalancer
kubeAPI:
  host: "0.0.0.0"
  hostPort: "6445"
options:
  k3s:
    extraArgs:
      - arg: "--tls-san=k8s-api-server"
        nodeFilters:
          - server:*
      - arg: "--tls-san=127.0.0.1"
        nodeFilters:
          - server:*
      - arg: "--tls-san=localhost"
        nodeFilters:
          - server:*
EOF

echo "Cluster config with $NUM_WORKERS worker nodes generated: /tmp/k3d-config.yaml"

echo "$(date '+%Y-%m-%d %H:%M:%S') | Creating K3d cluster with configuration..."
echo "$(date '+%Y-%m-%d %H:%M:%S') | ├── Name:  $CLUSTER_NAME"
echo "$(date '+%Y-%m-%d %H:%M:%S') | ├── Config: /tmp/k3d-config.yaml"
echo "$(date '+%Y-%m-%d %H:%M:%S') | └── Number of nodes: $((NUM_WORKERS + 1)) (1 server + $NUM_WORKERS agents)"

# Create k3d cluster
k3d cluster create --config /tmp/k3d-config.yaml

# ===============================================================================
#   Cluster Readiness Check
# ===============================================================================

echo "$(date '+%Y-%m-%d %H:%M:%S') | Verifying cluster status..."
CLUSTER_CHECK_COUNT=0

# Wait for k3d cluster to be ready (reduced wait time)
while ! k3d cluster list | grep -q "$CLUSTER_NAME"; do
    CLUSTER_CHECK_COUNT=$((CLUSTER_CHECK_COUNT+1))
    echo "$(date '+%Y-%m-%d %H:%M:%S') | [WAITING] K3d cluster '$CLUSTER_NAME' not ready yet... (attempt $CLUSTER_CHECK_COUNT)"
    sleep 2
    if [ $CLUSTER_CHECK_COUNT -gt 10 ]; then
        echo "$(date '+%Y-%m-%d %H:%M:%S') | [ERROR] Cluster creation timeout after 20 seconds"
        exit 1
    fi
done

echo "$(date '+%Y-%m-%d %H:%M:%S') | ✅ K3d cluster '$CLUSTER_NAME' is up and running!"

# ===============================================================================
#   Setup Complete
# ===============================================================================

echo "$(date '+%Y-%m-%d %H:%M:%S') | Docker and KIND environment is ready for use"

# Save kubeconfig and set API server address
# Use k3d loadbalancer container name (on ckx-network) so jumphost/remote-terminal can reach API server
# Loadbalancer exposes 6443 internally; k3d names it k3d-<cluster>-serverlb
k3d kubeconfig write $CLUSTER_NAME --kubeconfig-switch-context=false

# Update kubeconfig to use loadbalancer container name
if [ -f /home/candidate/.kube/config ]; then
    # Update the server address to use k3d loadbalancer container name
    sed -i 's|server: https://[^[:space:]]*|server: https://k3d-cluster-serverlb:6443|g' /home/candidate/.kube/config
    # Remove certificate-authority-data if it exists (cannot use with insecure-skip-tls-verify)
    sed -i '/certificate-authority-data:/d' /home/candidate/.kube/config
    # Add insecure-skip-tls-verify if not present
    if ! grep -q "insecure-skip-tls-verify" /home/candidate/.kube/config; then
        sed -i '/server: https:\/\/k3d-cluster-serverlb:6443/a\    insecure-skip-tls-verify: true' /home/candidate/.kube/config
    fi
fi
# Copy config to kubeconfig
cp /home/candidate/.kube/config /home/candidate/.kube/kubeconfig
# Ensure kubeconfig also has correct server address (double-check)
sed -i 's|server: https://[^[:space:]]*|server: https://k3d-cluster-serverlb:6443|g' /home/candidate/.kube/kubeconfig
# Remove certificate-authority-data if it exists
sed -i '/certificate-authority-data:/d' /home/candidate/.kube/kubeconfig
# Add insecure-skip-tls-verify if not present
if ! grep -q "insecure-skip-tls-verify" /home/candidate/.kube/kubeconfig; then
    sed -i '/server: https:\/\/k3d-cluster-serverlb:6443/a\    insecure-skip-tls-verify: true' /home/candidate/.kube/kubeconfig
fi
echo "$(date '+%Y-%m-%d %H:%M:%S') | ✅ Kubeconfig updated to use k3d-cluster-serverlb:6443 with insecure-skip-tls-verify"

export KUBECONFIG=/home/candidate/.kube/kubeconfig

#info on config file setup done 
echo "$(date '+%Y-%m-%d %H:%M:%S') | Config file setup done"

#info on cluster setup done 
echo "$(date '+%Y-%m-%d %H:%M:%S') | Cluster setup done"

exit 0